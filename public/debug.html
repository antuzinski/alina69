<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–û—Ç–ª–∞–¥–∫–∞ Realtime</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding: 16px;
      background: #000;
      color: #0f0;
      font-size: 14px;
      line-height: 1.4;
    }
    .status {
      position: sticky;
      top: 0;
      background: #111;
      padding: 12px;
      margin-bottom: 16px;
      border: 1px solid #0f0;
      border-radius: 4px;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 13px;
    }
    .status-value {
      font-weight: bold;
      color: #ff0;
    }
    .status-value.good { color: #0f0; }
    .status-value.bad { color: #f00; }
    button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      font-size: 16px;
      background: #0f0;
      color: #000;
      border: none;
      border-radius: 4px;
      font-weight: bold;
      cursor: pointer;
    }
    button:active {
      opacity: 0.7;
    }
    button:disabled {
      background: #666;
      color: #999;
    }
    .log {
      margin-top: 16px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .log-entry {
      padding: 8px;
      margin: 4px 0;
      background: #111;
      border-left: 3px solid #0f0;
      word-wrap: break-word;
      border-radius: 2px;
    }
    .log-entry.error {
      border-left-color: #f00;
      color: #f88;
    }
    .log-entry.success {
      border-left-color: #0f0;
      color: #0f0;
    }
    .log-entry.info {
      border-left-color: #0ff;
      color: #0ff;
    }
    .log-entry.event {
      border-left-color: #ff0;
      color: #ff0;
      font-weight: bold;
    }
    .timestamp {
      color: #666;
      font-size: 10px;
    }
    .clear-btn {
      background: #f00;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="status">
    <div class="status-item">
      <span>üîî –û–ø–æ–≤–µ—â–µ–Ω–∏—è:</span>
      <span id="notif-status" class="status-value">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
    </div>
    <div class="status-item">
      <span>üîå Realtime:</span>
      <span id="realtime-status" class="status-value">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
    </div>
    <div class="status-item">
      <span>üë§ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:</span>
      <span id="auth-status" class="status-value">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
    </div>
    <div class="status-item">
      <span>üìä –°–æ–±—ã—Ç–∏—è:</span>
      <span id="event-count" class="status-value">0</span>
    </div>
  </div>

  <button id="request-permission">–ó–∞–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è</button>
  <button id="test-notification" disabled>–¢–µ—Å—Ç–æ–≤–æ–µ –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ</button>
  <button id="create-task">–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–¥–∞—á—É</button>
  <button id="clear-logs" class="clear-btn">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏</button>

  <div class="log" id="log"></div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://hzylkemjmxjmxgqzilmn.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6eWxrZW1qbXhqbXhncXppbG1uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzAwMzcwMTIsImV4cCI6MjA0NTYxMzAxMn0.vktvjBJQGbw2CtHMwdkWXYf1S6gKp-f2NRx8fF30M48';

    let eventCount = 0;
    let supabase;
    let channel;
    let swRegistration;

    function updateStatus(id, text, isGood = null) {
      const el = document.getElementById(id);
      el.textContent = text;
      if (isGood === true) el.className = 'status-value good';
      else if (isGood === false) el.className = 'status-value bad';
      else el.className = 'status-value';
    }

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;

      const timestamp = new Date().toLocaleTimeString('ru-RU', { hour12: false });
      entry.innerHTML = `<div class="timestamp">${timestamp}</div>${message}`;

      logDiv.insertBefore(entry, logDiv.firstChild);

      if (logDiv.children.length > 100) {
        logDiv.removeChild(logDiv.lastChild);
      }
    }

    async function showNotification(title, options = {}) {
      try {
        if (swRegistration) {
          await swRegistration.showNotification(title, options);
          log(`üì¨ –û–ø–æ–≤–µ—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SW: ${title}`, 'success');
        } else {
          new Notification(title, options);
          log(`üì¨ –û–ø–æ–≤–µ—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API: ${title}`, 'success');
        }
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è: ${error.message}`, 'error');
      }
    }

    function checkNotificationPermission() {
      const permission = Notification.permission;
      log(`–°—Ç–∞—Ç—É—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${permission}`, 'info');

      if (permission === 'granted') {
        updateStatus('notif-status', '–†–∞–∑—Ä–µ—à–µ–Ω–æ ‚úì', true);
        document.getElementById('test-notification').disabled = false;
        return true;
      } else if (permission === 'denied') {
        updateStatus('notif-status', '–ó–∞–ø—Ä–µ—â–µ–Ω–æ ‚úó', false);
        return false;
      } else {
        updateStatus('notif-status', '–ù–µ –∑–∞–ø—Ä–æ—à–µ–Ω–æ', null);
        return false;
      }
    }

    document.getElementById('request-permission').addEventListener('click', async () => {
      log('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è...', 'info');

      try {
        const permission = await Notification.requestPermission();
        log(`–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–ø—Ä–æ—Å–∞: ${permission}`, permission === 'granted' ? 'success' : 'error');
        checkNotificationPermission();
      } catch (error) {
        log(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
      }
    });

    document.getElementById('test-notification').addEventListener('click', async () => {
      log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è...', 'info');
      await showNotification('–¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω! üéâ', {
        body: '–û–ø–æ–≤–µ—â–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ',
        icon: '/image.png',
        tag: 'test'
      });
    });

    document.getElementById('create-task').addEventListener('click', async () => {
      if (!supabase) {
        log('Supabase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
        return;
      }

      log('–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∑–∞–¥–∞—á–∏...', 'info');

      try {
        let userId = null;
        try {
          const { data: { user } } = await supabase.auth.getUser();
          userId = user?.id;
        } catch (e) {
          log('‚ö†Ô∏è Auth –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–∑–¥–∞–µ–º –±–µ–∑ user_id', 'info');
        }

        const { data, error } = await supabase
          .from('tasks')
          .insert({
            title: `–¢–µ—Å—Ç ${new Date().toLocaleTimeString('ru-RU')}`,
            description: '–¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Realtime',
            column_name: 'todo',
            position: 0,
            user_id: userId,
          })
          .select()
          .single();

        if (error) throw error;

        log(`‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: ${data.title}`, 'success');
        log(`ID: ${data.id}`, 'info');
      } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        log(`–î–µ—Ç–∞–ª–∏: ${JSON.stringify(error)}`, 'error');
      }
    });

    document.getElementById('clear-logs').addEventListener('click', () => {
      document.getElementById('log').innerHTML = '';
      eventCount = 0;
      updateStatus('event-count', '0');
      log('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
    });

    async function init() {
      log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...', 'info');

      // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
      if ('serviceWorker' in navigator) {
        try {
          swRegistration = await navigator.serviceWorker.register('/sw.js');
          log('‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', 'success');
        } catch (error) {
          log(`‚ö†Ô∏è SW –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ${error.message}`, 'error');
        }
      } else {
        log('‚ö†Ô∏è Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è', 'error');
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π
      checkNotificationPermission();

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
      try {
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
          auth: {
            persistSession: true,
            autoRefreshToken: true,
            storage: window.localStorage,
            storageKey: 'sb-memorycatalog-auth',
          },
          realtime: {
            params: {
              eventsPerSecond: 10,
            },
          },
        });

        log('‚úÖ Supabase –∫–ª–∏–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω', 'success');

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        try {
          const { data: { user }, error: authError } = await supabase.auth.getUser();

          if (authError) {
            log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ auth: ${authError.message}`, 'error');
            log(`‚ö†Ô∏è –î–µ—Ç–∞–ª–∏: ${JSON.stringify(authError)}`, 'error');
            updateStatus('auth-status', '–ê–Ω–æ–Ω–∏–º–Ω–æ', null);
          } else if (user) {
            log(`‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ${user.email}`, 'success');
            updateStatus('auth-status', user.email, true);
          } else {
            log('‚ö†Ô∏è –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω (–∞–Ω–æ–Ω–∏–º–Ω—ã–π –¥–æ—Å—Ç—É–ø)', 'info');
            updateStatus('auth-status', '–ê–Ω–æ–Ω–∏–º–Ω–æ', null);
          }
        } catch (authError) {
          log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å auth, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∞–Ω–æ–Ω–∏–º–Ω–æ`, 'error');
          updateStatus('auth-status', '–ê–Ω–æ–Ω–∏–º–Ω–æ', null);
        }

        // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Realtime
        log('üîå –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Realtime...', 'info');

        channel = supabase
          .channel('debug_tasks')
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'tasks',
            },
            (payload) => {
              eventCount++;
              updateStatus('event-count', eventCount);

              log(`üî• –°–û–ë–´–¢–ò–ï: ${payload.eventType}`, 'event');
              log(`–¢–∞–±–ª–∏—Ü–∞: ${payload.table}`, 'info');

              if (payload.new) {
                log(`–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(payload.new, null, 2)}`, 'info');
              }

              if (payload.old) {
                log(`–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(payload.old, null, 2)}`, 'info');
              }

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ
              if (Notification.permission === 'granted') {
                let title = '';
                let body = '';

                if (payload.eventType === 'INSERT' && payload.new) {
                  title = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
                  body = payload.new.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                } else if (payload.eventType === 'UPDATE' && payload.new) {
                  if (payload.new.completed_at && (!payload.old || !payload.old.completed_at)) {
                    title = '–ó–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞';
                    body = payload.new.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                  } else {
                    title = '–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞';
                    body = payload.new.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                  }
                } else if (payload.eventType === 'DELETE') {
                  title = '–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞';
                  body = payload.old?.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
                }

                if (title) {
                  showNotification(title, { body, icon: '/image.png' });
                }
              } else {
                log('‚ö†Ô∏è –û–ø–æ–≤–µ—â–µ–Ω–∏—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω—ã', 'error');
              }
            }
          )
          .subscribe((status, err) => {
            log(`–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'info');

            if (err) {
              log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏: ${err.message}`, 'error');
              updateStatus('realtime-status', '–û—à–∏–±–∫–∞', false);
            } else if (status === 'SUBSCRIBED') {
              log('‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞!', 'success');
              updateStatus('realtime-status', '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ ‚úì', true);
            } else if (status === 'CHANNEL_ERROR') {
              log('‚ùå –û—à–∏–±–∫–∞ –∫–∞–Ω–∞–ª–∞', 'error');
              updateStatus('realtime-status', '–û—à–∏–±–∫–∞', false);
            } else if (status === 'TIMED_OUT') {
              log('‚ùå –¢–∞–π–º-–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
              updateStatus('realtime-status', '–¢–∞–π–º-–∞—É—Ç', false);
            } else if (status === 'CLOSED') {
              log('‚ö†Ô∏è –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ', 'error');
              updateStatus('realtime-status', '–ó–∞–∫—Ä—ã—Ç–æ', false);
            }
          });

      } catch (error) {
        log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${error.message}`, 'error');
        log(error.stack, 'error');
      }
    }

    // –ó–∞–ø—É—Å–∫
    init();

    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫
    window.addEventListener('error', (e) => {
      log(`‚ùå JS Error: ${e.message}`, 'error');
      log(`–í —Ñ–∞–π–ª–µ: ${e.filename}:${e.lineno}`, 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      log(`‚ùå Unhandled Promise: ${e.reason}`, 'error');
    });
  </script>
</body>
</html>
